FROM swift:{SWIFT_VERSION}

# Install dependencies
RUN apt-get autoremove -y curl \
                          libcurl-dev \
                          libcurl3-gnutls \
                          libcurl4-openssl-dev

RUN apt-get -q update && \
    apt-get -q install -y \
    git \
    wget \
    g++ \
    make \
    binutils \
    autoconf \
    automake \
    autotools-dev \
    libtool \
    pkg-config \
    zlib1g-dev \
    libssl-dev \
    libxml2-dev

RUN mkdir /dependencies

# Build libnghttp2
RUN cd /dependencies && \
    git clone https://github.com/nghttp2/nghttp2 && \
    cd nghttp2 && \
    git checkout tags/{HTTP2_VERSION} && \
    autoreconf -i && \
    automake && \
    autoconf && \
    ./configure && \
    make && \
    make install

# Build libcurl with HTTP/2
RUN cd /dependencies && \
    wget https://curl.haxx.se/download/curl-{CURL_VERSION}.tar.gz && \
    tar -xf curl-{CURL_VERSION}.tar.gz && \
    cd curl-{CURL_VERSION} && \
    sed -i -e "s/CURL_@CURL_LT_SHLIB_VERSIONED_FLAVOUR@4/CURL_@CURL_LT_SHLIB_VERSIONED_FLAVOUR@3/g" lib/libcurl.vers.in && \
    ./configure --with-nghttp2 --with-ssl --enable-versioned-symbols && \
    make && \
    make install && \
    ldconfig

# Cleanup
WORKDIR /
RUN rm -rf /dependencies

# Print cURL Version
RUN curl --version